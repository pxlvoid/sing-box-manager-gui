# Мониторинг трафика через sing-box Clash API

## Статус реализации (обновлено: 2026-02-26)

Реализовано:

- ✅ WebSocket-прокси через backend для:
  - `/api/monitoring/ws/traffic` (up/down realtime)
  - `/api/monitoring/ws/connections` (realtime снапшоты connections)
- ✅ Агрегатор `/connections` с записью истории в основную SQLite
- ✅ Миграция БД `v7` и таблицы:
  - `traffic_samples`
  - `traffic_clients`
  - `traffic_resources`
- ✅ REST API для мониторинга:
  - `/api/monitoring/overview`
  - `/api/monitoring/history`
  - `/api/monitoring/clients`
  - `/api/monitoring/resources`
- ✅ UI:
  - отдельная страница `Monitoring`
  - виджет на `Dashboard` с переходом в детали
  - таблица клиентов (online + recently disconnected) + детализация по выбранному клиенту
  - график realtime upload/download

На что обратить внимание:

- ⚠️ Retention пока **не реализован** (история растет без авто-очистки).
- ⚠️ Клиент = `sourceIP` (NAT-устройства агрегируются в один “клиент”).
- ⚠️ `host` зависит от протокола/SNI и может быть пустым.
- ⚠️ Вебсокет-прокси реализован минималистично (без внешней WS-библиотеки), под текущий сценарий Clash API.

---
Ниже оставлена исходная спецификация/контекст задачи.

## Текущее состояние

- Clash API включен в конфиге (`external_controller` на порту 9091)
- Бэкенд проксирует только управление прокси-группами (`/proxy/groups`, `/proxy/delay`, `/proxy/mode`)
- Эндпоинты `/traffic` и `/connections` **не проксируются**, но доступны напрямую в sing-box
- Никаких изменений в конфиге sing-box не требуется

## Что можно сделать

| Возможность | Источник данных | Реализуемость |
|---|---|---|
| Общая скорость upload/download в реальном времени | `GET /traffic` (стрим, ~1 раз/сек) | Легко, данные уже есть |
| Список активных соединений | `GET /connections` | Легко, полный снапшот |
| Трафик по клиентам (по IP) | `connections[].metadata.sourceIP` + `upload/download` | Нужна агрегация на бэкенде |
| Посещаемые ресурсы по клиентам | `connections[].metadata.host` (SNI/hostname) | Есть, но только активные соединения |
| Через какой прокси идет трафик клиента | `connections[].chains` | Есть |
| Длительность подключения клиента | `connections[].start` (timestamp начала) | Есть, считаем от start до now |
| Кол-во активных соединений на клиента | Группировка по `sourceIP` | Нужна агрегация |
| Закрытые соединения (история) | Буфер на ~1000 последних | Есть, но ограничен |

## Ограничения

| Ограничение | Детали |
|---|---|
| Нет исторических данных | sing-box не хранит статистику - только текущие и ~1000 последних закрытых соединений. Для истории нужно самим писать в БД |
| Нет кумулятивного трафика за период | `/traffic` отдает дельту (байт/сек), суммарный трафик только в `/connections` (`uploadTotal`/`downloadTotal`) и сбрасывается при рестарте |
| Клиент = IP-адрес | Нет имен пользователей, только `sourceIP`. Если несколько устройств за NAT - будут один "клиент" |
| host не всегда доступен | Для HTTPS виден SNI, для HTTP - Host header, но для некоторых соединений может быть только IP |
| Нет полных URL | Только hostname/SNI, не полный путь (HTTPS шифрует путь) |
| Потеря данных при рестарте | Вся статистика обнуляется при рестарте sing-box |

## Формат данных Clash API

### GET /traffic (стрим)

Стримит JSON-объекты каждую ~1 секунду (WebSocket или HTTP chunked):

```json
{
  "up": 12345,
  "down": 67890
}
```

Значения - байты за последнюю секунду (дельта, не кумулятивные).

### GET /connections (снапшот или стрим)

- HTTP GET - одноразовый JSON снапшот
- WebSocket - стрим снапшотов каждую 1000мс (настраивается через `?interval=`)

```json
{
  "downloadTotal": 1234567890,
  "uploadTotal": 987654321,
  "connections": [
    {
      "id": "uuid-string",
      "metadata": {
        "network": "tcp",
        "type": "HTTP",
        "sourceIP": "192.168.1.100",
        "sourcePort": "54321",
        "destinationIP": "93.184.216.34",
        "destinationPort": "443",
        "host": "example.com",
        "processPath": "/usr/bin/curl",
        "inboundType": "mixed",
        "inboundName": "mixed-in"
      },
      "upload": 1024,
      "download": 4096,
      "start": "2024-01-01T00:00:00Z",
      "chains": ["proxy-tag", "selector-tag"],
      "rule": "geosite:google",
      "rulePayload": "google"
    }
  ],
  "memory": {
    "inuse": 12345678,
    "oslimit": 0
  }
}
```

## Что нужно построить

### Бэкенд

1. **WebSocket-прокси** для `/traffic` и `/connections` стримов (текущий хелпер `clashAPIRequest` не поддерживает WebSocket)
2. **Агрегатор** - периодически полить `/connections`, группировать по `sourceIP`, суммировать трафик, сохранять в БД для истории
3. **Таблица в БД** для хранения исторических данных (трафик по клиентам, посещенные ресурсы)

### Фронтенд

1. **Графики скорости** - realtime upload/download (из `/traffic` стрима)
2. **Таблица клиентов** - IP, активные соединения, трафик, длительность
3. **Список посещаемых ресурсов** - hostname по клиентам (из `metadata.host`)
4. **Дашборд-виджет** - общая скорость и кол-во активных соединений
