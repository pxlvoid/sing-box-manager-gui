**│*****Settings: навигация, сворачиваемые секции, автосохранение с откатом***                                                                                      **│**

**│**                                                                                                                                                          **│**

**│** **Контекст** **                                                                                                                                                **│

**│**                                                                                                                                                          **│**

**│** Страница Settings (**web/src/pages/Settings.tsx**) — длинная плоская страница из 7 **`<Card>`** секций. Сейчас нет ни быстрой навигации, ни возможности свернуть **  **│

**│** секцию, ни автосохранения — только одна кнопка "Save Settings" сверху. Нужно сделать UX удобнее. **                                                        **│

**│**                                                                                                                                                          **│**

**│** **Что делаем** **                                                                                                                                              **│

**│**                                                                                                                                                          **│**

**│** **1. Быстрая навигация (sticky sidebar / scroll-to-section)**                                                                                                **│**

**│**                                                                                                                                                          **│**

**│** - Добавляем sticky-панель навигации слева (на десктопе) или горизонтальный скролл-бар сверху (на мобильных). **                                            **│

**│** - Список пунктов: sing-box, Inbound, DNS, Control Panel, Automation, Debug API, Background Service.**                                                      **│

**│** - Каждый пункт — **`<a>`** со **scrollIntoView({ behavior: 'smooth' })** к соответствующей секции. **                                                                **│

**│** - Активный пункт подсвечивается на основе **IntersectionObserver** (отслеживаем какая секция видна). **                                                        **│

**│**                                                                                                                                                          **│**

**│** **2. Сворачиваемые секции**                                                                                                                                  **│**

**│**                                                                                                                                                          **│**

**│** - Заменяем **`<Card>`** на **`<Accordion>`** из **@nextui-org/react** (уже используется в **NodeModal.tsx**).**                                                                **│

**│** - Используем **selectionMode="multiple"** и **defaultExpandedKeys** — все секции развёрнуты по умолчанию.**                                                        **│

**│** - Состояние свёрнутости хранится в **localStorage** чтобы запоминать между визитами. **                                                                        **│

**│**                                                                                                                                                          **│**

**│** **3. Автосохранение с дебаунсом**                                                                                                                            **│**

**│**                                                                                                                                                          **│**

**│** - При каждом изменении **formData** запускается **debounce(autoSave, 1500ms)**.**                                                                                  **│

**│** - **autoSave** вызывает **updateSettings(formData)** и показывает ненавязчивый статус (маленький индикатор "Saving..." / "Saved" рядом с заголовком).**            **│

**│** - Кнопка "Save Settings" убирается полностью. Вместо неё — текстовый индикатор статуса (Saving.../Saved).**                                                **│

**│**                                                                                                                                                          **│**

**│** **4. Откат конкретной настройки к предыдущему значению** **                                                                                                    **│

**│**                                                                                                                                                          **│**

**│** - Перед каждым автосохранением запоминаем **previousSettings** (предыдущее состояние, которое вернулось от сервера). **                                        **│

**│** - Для каждого поля, которое отличается от **previousSettings**, показываем кнопку "Undo" (иконка **Undo2**). **                                                    **│

**│** - При нажатии — возвращаем это конкретное поле к значению из **previousSettings** и сохраняем. **                                                              **│

**│** - Кнопка Undo появляется только после автосохранения (если поле изменилось) и исчезает после отката или следующего сохранения. **                          **│

**│**                                                                                                                                                          **│**

**│** **Файлы**                                                                                                                                                    **│**

**│**                                                                                                                                                          **│**

**│** ┌────────────────────────────┬──────────────────────────────────────────────────────────────────┐**                                                        **│

**│** │**            **Файл**            **│**                            **Изменения **                            **│**                                                        **│

**│** ├────────────────────────────┼──────────────────────────────────────────────────────────────────┤**                                                        **│

**│** │ **web/src/pages/Settings.tsx** │ Основная переработка: Accordion, навигация, автосохранение, undo │**                                                        **│

**│** ├────────────────────────────┼──────────────────────────────────────────────────────────────────┤**                                                        **│

**│** │ **web/src/store/index.ts** **    **│ Добавить **previousSettings** в стор, обновлять при **updateSettings** **  **│**                                                        **│

**│** └────────────────────────────┴──────────────────────────────────────────────────────────────────┘**                                                        **│

**│**                                                                                                                                                          **│**

**│** **Детали** **реализации**                                                                                                                                        **│**

**│**                                                                                                                                                          **│**

**│** **Навигация** **—** **sticky** **sidebar** **(десктоп)** **+** **горизонтальные** **чипы** **(мобайл)**                                                                                      **│**

**│**                                                                                                                                                          **│**

**│**const** SECTIONS = [ **                                                                                                                                      **│**

**│** **  **{ **id**: **'singbox'**, **label**: **'sing-box'**, **icon**: Terminal },**                                                                                                  **│

**│** **  **{ **id**: **'inbound'**, **label**: **'Inbound'**, **icon**: Download }, **                                                                                                  **│

**│** **  **{ **id**: **'dns'**, **label**: **'DNS'**, **icon**: Upload }, **                                                                                                            **│

**│** **  **{ **id**: **'panel'**, **label**: **'Control**Panel'** }, **                                                                                                              **│**

**│** **  **{ **id**: **'automation'**, **label**: **'Automation'** }, **                                                                                                            **│

**│** **  **{ **id**: **'debug'**, **label**: **'Debug**API'** }, **                                                                                                                  **│**

**│** **  **{ **id**: **'daemon'**, **label**: **'Service'** },**                                                                                                                    **│

**│** ]; **                                                                                                                                                      **│

**│**                                                                                                                                                          **│**

**│** - Layout: **flex** с sidebar **w-48**sticky**top-4**hidden**lg:block** слева и основным контентом справа.**                                                            **│

**│** - На **lg:** и меньше sidebar скрыт, вместо него — sticky горизонтальная полоска чипов (**overflow-x-auto**).**                                                    **│

**│** - Каждый **`<AccordionItem>`** получает **data-section={section.id}**. **                                                                                            **│

**│** - **IntersectionObserver** с **threshold:**0.3** определяет активную секцию.**                                                                                      **│**

**│** - Клик по пункту навигации → **scrollIntoView({**behavior:**'smooth',**block:**'start'**})**. **                                                                    **│**

**│**                                                                                                                                                          **│**

**│** **Автосохранение** **                                                                                                                                          **│

**│**                                                                                                                                                          **│**

**│**const** saveTimeoutRef = useRef<ReturnType<**typeof**setTimeout**>>();**                                                                                          **│

**│**const** [saveStatus, setSaveStatus] = useState<**'idle'** | **'saving'** | **'saved'** | **'error'**>(**'idle'**); **                                                            **│**

**│**                                                                                                                                                          **│**

**│** useEffect(**()**=>** {**                                                                                                                                        **│**

**│** **  **if** (!formData || !settings) **return**;**                                                                                                                    **│**

**│** **  **//**Не**сохранять**при**инициализации**                                                                                                                      **│

**│** **  **if** (**JSON**.stringify(formData) === **JSON**.stringify(settings)) **return**; **                                                                                    **│**

**│**                                                                                                                                                          **│**

**│** **  **setSaveStatus(**'idle'**); **                                                                                                                                **│

**│** **  **clearTimeout**(saveTimeoutRef.current);**                                                                                                                  **│**

**│** **  **saveTimeoutRef.current = **setTimeout**(**async** () => {**                                                                                                      **│

**│** **    **setSaveStatus(**'saving'**); **                                                                                                                            **│

**│** **    **try** {**                                                                                                                                                **│**

**│** **      **await** updateSettings(formData);**                                                                                                                    **│**

**│** **      **setSaveStatus(**'saved'**);**                                                                                                                            **│

**│** **    **} **catch** {**                                                                                                                                            **│

**│** **      **setSaveStatus(**'error'**);**                                                                                                                            **│

**│** **    **}**                                                                                                                                                    **│

**│** **  **}, **1500**);**                                                                                                                                              **│

**│**                                                                                                                                                          **│**

**│** **  **return**()**=>**clearTimeout**(saveTimeoutRef.current); **                                                                                                    **│

**│** }, [formData]);**                                                                                                                                          **│

**│**                                                                                                                                                          **│**

**│** **Undo** **per** **field** **                                                                                                                                          **│

**│**                                                                                                                                                          **│**

**│** - В store: при **updateSettings** сохраняем текущий **settings** как **previousSettings** перед обновлением. **                                                        **│

**│** - В UI: для каждого поля проверяем **previousSettings[field]**!==**settings[field]** — если отличается, показываем кнопку undo.**                                **│

**│** - Undo: **setFormData({**...formData,**[field]:**previousSettings[field]**})** → автосохранение подхватит. **                                                      **│

**│**                                                                                                                                                          **│**

**│** **Состояние** **Accordion** **в** **localStorage** **                                                                                                                      **│

**│**                                                                                                                                                          **│**

**│**const** [expandedKeys, setExpandedKeys] = useState<**Set**<**string**>>(**()**=>** {**                                                                                    **│

**│** **  **const** saved = **localStorage**.getItem(**'settings-sections'**); **                                                                                              **│**

**│** **  **return** saved ? **new**Set**(**JSON**.parse(saved)) : **new**Set**(SECTIONS.map(**s**=>** s.id));**                                                                          **│

**│** });**                                                                                                                                                      **│

**│**                                                                                                                                                          **│**

**│** useEffect(**()**=>** {**                                                                                                                                        **│**

**│** **  **localStorage**.setItem(**'settings-sections'**, **JSON**.stringify([...expandedKeys]));**                                                                          **│**

**│** }, [expandedKeys]);**                                                                                                                                      **│

**│**                                                                                                                                                          **│**

**│** **Проверка** **                                                                                                                                                **│

**│**                                                                                                                                                          **│**

**│** 1. Открыть Settings — все секции развёрнуты, навигация видна **                                                                                            **│

**│** 2. Свернуть секцию → перезагрузить → остаётся свёрнутой**                                                                                                  **│

**│** 3. Кликнуть на пункт навигации → скролл к секции **                                                                                                        **│

**│** 4. Изменить настройку → через ~1.5с появляется "Saved" **                                                                                                  **│

**│** 5. После сохранения — у изменённого поля видна кнопка Undo **                                                                                              **│

**│** 6. Нажать Undo → поле откатывается, автосохраняется **     **
