# Анализ соответствия системы видению пользователя

## Видение

> Сервер-реле принимает inbound (HTTP/SOCKS/Shadowsocks) от клиентов.
> Автоматически проверяет подписки и ноды: доступность, сайты (YouTube, ChatGPT, Instagram...), скорость.
> Прошедшие проверку — в «одобренные», не прошедшие — в «отстойник».
> На дашборде можно выбрать прокси вручную или система сама выставляет лучшую и заменяет при отказе.
> Результат — «супер-прокся», всегда дающая доступ к интернету.

---

## Что УЖЕ реализовано

### 1. Inbound-прокси для клиентов — ЕСТЬ

Система генерирует полный конфиг sing-box с inbound'ами:

| Тип | Авторизация | Настройки |
|-----|-------------|-----------|
| Mixed (HTTP+SOCKS5) | нет | порт, allow_lan |
| SOCKS5 | username/password | порт, allow_lan |
| HTTP | username/password | порт, allow_lan |
| Shadowsocks | method + password | порт, allow_lan |
| TUN | — | включается отдельно |

Dashboard генерирует shareable ссылки (`socks5://`, `http://`, `ss://`) и QR-код для Shadowsocks. Клиенты подключаются — трафик уходит через выбранный outbound.

**Вердикт: полностью покрывает требование.**

---

### 2. Подписки и одиночные ноды — ЕСТЬ

- Подписки: добавление по URL, автообновление по расписанию (scheduler), парсинг нод
- Manual nodes: ручное добавление одиночных нод (7 протоколов: SS, VMess, VLESS, Trojan, Hysteria2, TUIC, SOCKS)
- Bulk add: пакетное добавление нод из текста/ссылок
- Дедупликация по `server:port` при копировании
- Отслеживание источника (`source_subscription_id`)

**Вердикт: полностью покрывает требование.**

---

### 3. Health check (доступность) — ЕСТЬ

- Отдельный probe-инстанс sing-box для тестирования (не мешает основному)
- Параллельная проверка (до 50 нод одновременно) через Clash API delay endpoint
- Результаты сохраняются в SQLite (`health_measurements`)
- Статистика стабильности: uptime %, средний latency, тренд (растёт/падает/стабильно)
- Цветовая индикация: зелёный ≥80%, жёлтый 50–80%, красный <50%

**Вердикт: полностью покрывает требование.**

---

### 4. Site check (проверка сайтов) — ЕСТЬ

- Дефолтные сайты: `chatgpt.com`, `youtube.com`, `instagram.com`, `2ip.ru`
- Можно передать кастомные сайты в запросе
- Измеряет HTTP response time к каждому сайту через каждую ноду
- Результаты сохраняются в SQLite (`site_measurements`)

**Вердикт: покрывает требование. Но список сайтов для проверки не настраивается через UI Settings — только при запуске проверки.**

---

### 5. Конвейер «проверил → одобрил / отклонил» — ЧАСТИЧНО

Что есть:
- **Auto-pipeline**: при обновлении подписки автоматически: health check → фильтр alive → копирование в manual nodes с дедупликацией
- **Stale nodes**: ноды помечаются как «stale» если: исчезли из подписки ИЛИ N провалов подряд
- **Pipeline remove dead**: опция автоудаления stale нод
- **Quick actions**: «Copy Alive to Manual», «Check & Copy» в один клик

Чего НЕТ:
- **Формального «отстойника»** — нет отдельного списка/таба «отклонённые ноды» куда попадают не прошедшие проверку. Stale ноды — это пометка на существующих manual нодах, а не отдельная категория
- **Автоматической связки site check → решение** — site check результаты отображаются, но pipeline использует только health check (alive/dead) и stability %. Если нода alive, но дропает YouTube — pipeline всё равно её скопирует
- **Проверки скорости** — нет bandwidth/throughput тестирования, только latency (мс)

**Вердикт: 70% от требования. Конвейер работает, но решение «подходит/не подходит» основано только на alive + latency, без учёта site check результатов и скорости.**

---

### 6. Выбор прокси на дашборде — ЕСТЬ

- **Active Proxy selector**: dropdown на Dashboard с поиском
- Можно выбрать: Auto (urltest), конкретную ноду, страновую группу, фильтр-группу
- Отображение текущего пинга с цветовой индикацией
- Переключение через Clash API (`PUT /proxies/:group`)

**Вердикт: полностью покрывает требование.**

---

### 7. Автоматический выбор лучшей ноды — ЧАСТИЧНО

Что есть:
- **sing-box urltest**: группа `Auto` автоматически выбирает ноду с минимальным latency, перепроверяет каждые 5 минут, tolerance 50мс
- **Страновые urltest**: автогруппы по странам с аналогичной логикой
- **Фильтры urltest**: пользовательские группы с настраиваемым URL/interval/tolerance

Чего НЕТ:
- **Автовыбора на уровне приложения** — если пользователь выбрал конкретную ноду (не Auto), и она умерла, sing-box НЕ переключит автоматически (selector ≠ urltest)
- **Watchdog/мониторинга** — нет фонового процесса который следит «работает ли мой текущий прокси?» и переключает при отказе
- **Выбора по скорости** — urltest выбирает по latency, но не по bandwidth

**Вердикт: 60% от требования. Внутри urltest-групп failover работает, но нет полноценного application-level failover.**

---

### 8. Автозамена при отказе ноды — НЕТ (как real-time)

| Сценарий | Поведение |
|----------|-----------|
| Пользователь на «Auto» + нода умерла | sing-box переключит в течение 5 минут (urltest interval) |
| Пользователь выбрал конкретную ноду + она умерла | **НЕТ автозамены**. Трафик пропадает до ручного переключения |
| Между запусками scheduler'а нода умерла | Pipeline не узнает до следующего запуска (по умолчанию 60 мин) |

**Вердикт: критический пробел. Для «супер-прокси, которая всегда даёт доступ» нужен real-time failover.**

---

## Итоговая таблица

| Требование | Статус | Покрытие |
|------------|--------|----------|
| Inbound HTTP/SOCKS/SS для клиентов | ✅ Есть | 100% |
| Подписки + одиночные ноды | ✅ Есть | 100% |
| Health check (alive/latency) | ✅ Есть | 100% |
| Site check (YouTube, ChatGPT...) | ✅ Есть | 90% |
| Статистика стабильности | ✅ Есть | 100% |
| Конвейер: проверка → одобрение | ⚠️ Частично | 70% |
| Выбор прокси на Dashboard | ✅ Есть | 100% |
| Auto-pipeline (batch) | ✅ Есть | 100% |
| Автовыбор лучшей ноды | ⚠️ Частично | 60% |
| Real-time failover при отказе | ❌ Нет | 10% |
| Тестирование скорости (bandwidth) | ❌ Нет | 0% |
| «Отстойник» для отклонённых нод | ❌ Нет | 0% |
| Site check влияет на auto-pipeline | ❌ Нет | 0% |

**Общее покрытие: ~70%**

---

## Что нужно доработать (приоритет по влиянию)

### P0 — Критично для «супер-прокси»

1. **Real-time failover watchdog**
   - Фоновый горутин, который каждые 30–60 сек проверяет «жив ли текущий active proxy»
   - Если мёртв — автоматически переключает на следующий лучший через Clash API
   - Если пользователь на конкретной ноде — переключить на Auto или на следующую из той же группы
   - Логирование переключений

2. **Site check как критерий pipeline**
   - Pipeline должен учитывать не только alive/latency, но и site check
   - Настраиваемый список «обязательных сайтов» в Settings
   - Нода проходит в manual только если alive + все обязательные сайты доступны

### P1 — Важно для UX

3. **«Отстойник» (rejected nodes)**
   - Отдельный таб/секция для нод не прошедших проверку
   - Причина отклонения: dead / site X недоступен / latency > порога / скорость < порога
   - Возможность повторной проверки и возврата в «одобренные»

4. **Тестирование скорости (bandwidth)**
   - Download speed test через прокси (скачивание тестового файла)
   - Результат в Мбит/с, сохранение в SQLite
   - Минимальный порог скорости в pipeline настройках

### P2 — Улучшения

5. **Настройка списка сайтов в Settings**
   - UI для управления списком сайтов для site check
   - Персистентное хранение в БД (сейчас только дефолтные + ad-hoc при запуске)

6. **Настраиваемые параметры urltest**
   - UI для interval и tolerance глобальной Auto-группы (сейчас захардкожено 5 мин / 50мс)
   - Более агрессивный интервал для критичных сценариев (30 сек)

---

## Архитектурная оценка

**Фундамент — крепкий:**
- SQLite с транзакциями и миграциями
- Probe-based тестирование (отдельный инстанс)
- Модульная структура (store interface, отдельные файлы по доменам)
- Auto-pipeline с scheduler'ом
- Clash API интеграция для управления

**Главный gap — реактивность:**
Система работает в batch-режиме (проверил → скопировал → применил конфиг). Для «супер-прокси, которая всегда работает» нужна real-time реактивность: мониторинг текущего соединения и мгновенное переключение при проблемах.

Текущая архитектура позволяет добавить watchdog без серьёзного рефакторинга — Clash API уже используется для переключения прокси, нужно только добавить фоновый мониторинг.
